statement ok
set max_block_size = 1;

statement ok
CREATE or replace TABLE issue2549 AS SELECT * FROM (VALUES
	(0, 1, 614),
	(1, 1, null),
	(2, 1, null),
	(3, 1, 639),
	(4, 1, 2027)
) tbl(id, user_id, order_id);

query IIII
SELECT
  id,
  user_id,
  order_id,
  LAST_VALUE (order_id) IGNORE NULLS over (
    PARTITION BY user_id
    ORDER BY id
    ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING
  ) AS last_order_id
FROM issue2549
----
0	1	614	NULL
1	1	NULL	614
2	1	NULL	614
3	1	639	614
4	1	2027	639

query IIII
SELECT
  id,
  user_id,
  order_id,
  FIRST_VALUE (order_id) IGNORE NULLS over (
    PARTITION BY user_id
    ORDER BY id
    ROWS BETWEEN 1 PRECEDING AND UNBOUNDED FOLLOWING
  ) AS last_order_id
FROM issue2549
----
0	1	614	614
1	1	NULL	614
2	1	NULL	639
3	1	639	639
4	1	2027	639

query IIII
SELECT
  id,
  user_id,
  order_id,
  NTH_VALUE (order_id, 2) IGNORE NULLS over (
    PARTITION BY user_id
    ORDER BY id
    ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING
  ) AS last_order_id
FROM issue2549
----
0	1	614	NULL
1	1	NULL	NULL
2	1	NULL	NULL
3	1	639	NULL
4	1	2027	639

query IIII
SELECT
  id,
  user_id,
  order_id,
  LEAD(order_id, 1, 200) IGNORE NULLS over (
    PARTITION BY user_id
    ORDER BY id
  ) AS last_order_id
FROM issue2549
----
0 1 614 200
1 1 NULL 200
2 1 NULL 639
3 1 639 2027
4 1 2027 200

query IIII
SELECT
  id,
  user_id,
  order_id,
  LAG(order_id, 1, 200) IGNORE NULLS over (
    PARTITION BY user_id
    ORDER BY id
  ) AS last_order_id
FROM issue2549
----
0 1 614 200
1 1 NULL 614
2 1 NULL 200
3 1 639 200
4 1 2027 639


# Zero LAG is always identity
query IIII
SELECT
  id,
  user_id,
  order_id,
  LAG(order_id, 0, 200) IGNORE NULLS over (
    PARTITION BY user_id
    ORDER BY id
  ) AS last_order_id
FROM issue2549
----
0 1 614 614
1 1 NULL NULL
2 1 NULL NULL
3 1 639 639
4 1 2027 2027


query IIII
SELECT
  id,
  user_id,
  order_id,
  Lead(order_id, 0, 200) IGNORE NULLS over (
    PARTITION BY user_id
    ORDER BY id
  ) AS last_order_id
FROM issue2549
----
0 1 614 614
1 1 NULL NULL
2 1 NULL NULL
3 1 639 639
4 1 2027 2027

statement ok
unset max_block_size;

statement ok
CREATE or replace TABLE issue2549 AS SELECT * FROM (VALUES
	(0, 1, 614),
	(1, 1, null),
	(2, 1, null),
	(3, 1, 639),
	(4, 1, 2027)
) tbl(id, user_id, order_id);

query IIII
SELECT
  id,
  user_id,
  order_id,
  LAST_VALUE (order_id) IGNORE NULLS over (
    PARTITION BY user_id
    ORDER BY id
    ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING
  ) AS last_order_id
FROM issue2549
----
0	1	614	NULL
1	1	NULL	614
2	1	NULL	614
3	1	639	614
4	1	2027	639

query IIII
SELECT
  id,
  user_id,
  order_id,
  FIRST_VALUE (order_id) IGNORE NULLS over (
    PARTITION BY user_id
    ORDER BY id
    ROWS BETWEEN 1 PRECEDING AND UNBOUNDED FOLLOWING
  ) AS last_order_id
FROM issue2549
----
0	1	614	614
1	1	NULL	614
2	1	NULL	639
3	1	639	639
4	1	2027	639

query IIII
SELECT
  id,
  user_id,
  order_id,
  NTH_VALUE (order_id, 2) IGNORE NULLS over (
    PARTITION BY user_id
    ORDER BY id
    ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING
  ) AS last_order_id
FROM issue2549
----
0	1	614	NULL
1	1	NULL	NULL
2	1	NULL	NULL
3	1	639	NULL
4	1	2027	639

query IIII
SELECT
  id,
  user_id,
  order_id,
  LEAD(order_id, 1, 200) IGNORE NULLS over (
    PARTITION BY user_id
    ORDER BY id
  ) AS last_order_id
FROM issue2549
----
0 1 614 200
1 1 NULL 200
2 1 NULL 639
3 1 639 2027
4 1 2027 200

query IIII
SELECT
  id,
  user_id,
  order_id,
  LAG(order_id, 1, 200) IGNORE NULLS over (
    PARTITION BY user_id
    ORDER BY id
  ) AS last_order_id
FROM issue2549
----
0 1 614 200
1 1 NULL 614
2 1 NULL 200
3 1 639 200
4 1 2027 639


# Zero LAG is always identity
query IIII
SELECT
  id,
  user_id,
  order_id,
  LAG(order_id, 0, 200) IGNORE NULLS over (
    PARTITION BY user_id
    ORDER BY id
  ) AS last_order_id
FROM issue2549
----
0 1 614 614
1 1 NULL NULL
2 1 NULL NULL
3 1 639 639
4 1 2027 2027

query IIII
SELECT
  id,
  user_id,
  order_id,
  Lead(order_id, 0, 200) IGNORE NULLS over (
    PARTITION BY user_id
    ORDER BY id
  ) AS last_order_id
FROM issue2549
----
0 1 614 614
1 1 NULL NULL
2 1 NULL NULL
3 1 639 639
4 1 2027 2027

statement ok
drop TABLE issue2549
